<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
  <title>Kwartzリファレンスマニュアル</title>
  <meta name="author" content="Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;">
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <link rel="stylesheet" href="docstyle.css" type="text/css">
 </head>
 <body>

  <blockquote>
   <div class="mainbody">

    <div align="left"><h1>Kwartzリファレンスマニュアル</h1></div>
    <div align="left">
      Makoto Kuwata &lt;kwa(at)kuwata-lab.com&gt;<br>
      last update: $Date$<br>
    </div>

<a name="preface"></a>
<h2 class="section1">はじめに</h2>
<p>このドキュメントは、Kwartzのリファレンスマニュアルです。
プレゼンテーション用言語「PL」、ディレクティブ、コマンドラインオプション、
設定オプションについて説明しています。
</p>
<a name="toc"></a>
<h3 class="section2">目次</h3>
<ul>
  <li><a href="#preface">はじめに</a>
  <ul>
    <li><a href="#toc">目次</a>
    </li>
  </ul>
  </li>
  <li><a href="#pl">プレゼンテーション用言語「PL」</a>
  <ul>
    <li><a href="#pl-comment">コメント</a>
    </li>
    <li><a href="#pl-string">文字列</a>
    </li>
    <li><a href="#pl-boolean">真偽値、null</a>
    </li>
    <li><a href="#pl-variable">変数</a>
    </li>
    <li><a href="#pl-op">演算子</a>
    </li>
    <li><a href="#pl-print">出力</a>
    </li>
    <li><a href="#pl-assign">代入</a>
    </li>
    <li><a href="#pl-array">配列、ハッシュ</a>
    </li>
    <li><a href="#pl-property">プロパティとメソッド</a>
    </li>
    <li><a href="#pl-foreach">繰り返し</a>
    </li>
    <li><a href="#pl-if">条件分岐</a>
    </li>
    <li><a href="#pl-func">関数</a>
    </li>
    <li><a href="#pl-empty">empty</a>
    </li>
    <li><a href="#pl-decl">エレメント宣言</a>
    </li>
    <li><a href="#pl-doc">ドキュメント宣言</a>
    </li>
    <li><a href="#pl-rawcode">ターゲット言語のプログラムコード</a>
    </li>
    <li><a href="#pl-scope">グローバル変数とローカル変数</a>
    </li>
    <li><a href="#pl-infuture">未実装（または検討中）の機能</a>
    </li>
  </ul>
  </li>
  <li><a href="#kd">ディレクティブ</a>
  <ul>
    <li><a href="#kd-whatis">ディレクティブとは？</a>
    </li>
    <li><a href="#kd-mark">マーキング</a>
    </li>
    <li><a href="#kd-output">値の出力</a>
    </li>
    <li><a href="#kd-value">値の出力2</a>
    </li>
    <li><a href="#kd-attr">属性値の設定</a>
    </li>
    <li><a href="#kd-append">属性の追加</a>
    </li>
    <li><a href="#kd-set">変数への代入</a>
    </li>
    <li><a href="#kd-if">条件分岐</a>
    </li>
    <li><a href="#kd-foreach">繰り返し(foreach)</a>
    </li>
    <li><a href="#kd-loop">繰り返し(loop)</a>
    </li>
    <li><a href="#kd-foreach2">カウンタつき繰り返し(Foreach,Loop)</a>
    </li>
    <li><a href="#kd-foreach3">トグルつき繰り返し(FOREACH,LOOP)</a>
    </li>
    <li><a href="#kd-while">繰り返し(while)</a>
    </li>
    <li><a href="#kd-dummy">ダミーデータ</a>
    </li>
    <li><a href="#kd-replace">エレメントの置換</a>
    </li>
    <li><a href="#kd-placeholder">プレースホルダ</a>
    </li>
    <li><a href="#kd-include">プレゼンテーションデータファイルの読み込み</a>
    </li>
    <li><a href="#kd-idkd">id属性とkw:d属性について</a>
    </li>
    <li><a href="#kd-notes">注意事項</a>
    </li>
  </ul>
  </li>
  <li><a href="#plogic">プレゼンテーションロジックファイル</a>
  </li>
  <li><a href="#opt">コマンドラインオプション</a>
  </li>
  <li><a href="#config">設定オプション</a>
  </li>
</ul>
<br>


<br>


<a name="pl"></a>
<h2 class="section1">プレゼンテーション用言語「PL」</h2>
<p>PLとは、Kwartzにおいてプレゼンテーションロジックを記述するのに利用される言語です。
この章では、PLの書き方について説明します。
</p>
<a name="pl-comment"></a>
<h3 class="section2">コメント</h3>
<p>「<code>/*</code>」と「<code>*/</code>」で囲まれた範囲と、「<code>//</code>」から行末まではコメントになります。
</p>
<pre class="program">// ここはコメント
/*
  ここもコメント
*/
</pre>
<br>


<a name="pl-string"></a>
<h3 class="section2">文字列</h3>
<p>文字列は「<code>"..."</code>」または「<code>'...'</code>」で表します。
前者には改行(Line Feed)「\n」と復改(Carriage Returen)「\r」とタブ(Tab)「\t」を含めることができます。
</p>
<pre class="program">'foo bar'         // 文字列
"foo bar\n"       // 改行を含む文字列
</pre>
<br>


<a name="pl-boolean"></a>
<h3 class="section2">真偽値、null</h3>
<p>式の中で <code>true</code>、<code>false</code>、<code>null</code> が使えます。
</p>
<pre class="program">flag = obj == null ? true : false;
</pre>
<p><code>true</code>、<code>false</code>、<code>null</code>は各言語において次のように変換されます。
</p>
<div align="center">
<table class="table1" border="1" cellspacing="0" summary="	<code>true</code>、<code>false</code>、<code>null</code>の変換
">
 <caption class="caption1">
	<code>true</code>、<code>false</code>、<code>null</code>の変換
 </caption>
 <tr class="tr1">
  <th class="th1">変換先言語</th>
  <th class="th1">true</th>
  <th class="th1">false</th>
  <th class="th1">null</th>
 </tr>
 <tr class="tr1">
  <td class="td1">PHP</td>
  <td class="td1">TRUE</td>
  <td class="td1">FALSE</td>
  <td class="td1">NULL</td>
 </tr>
 <tr class="tr1">
  <td class="td1">eRuby</td>
  <td class="td1">true</td>
  <td class="td1">false</td>
  <td class="td1">nil</td>
 </tr>
 <tr class="tr1">
  <td class="td1">JSP(JSTL)</td>
  <td class="td1">true</td>
  <td class="td1">false</td>
  <td class="td1">null</td>
 </tr>
 <tr class="tr1">
  <td class="td1">Velocity</td>
  <td class="td1">true</td>
  <td class="td1">false</td>
  <td class="td1">-</td>
 </tr>
</table>
</div>
<p>なおVelocityではnullやそれに類するキーワードがありません。
そのため、nullを含むPLプログラムをVelocityに変換するとエラーになります。
ただしnullとの比較を行う論理式は、nullを使わない式に変換されます。
</p>
<p>PLプログラム：
</p>
<a name="pl-boolean.plogic"></a>
<pre class="program">flag = obj == null? true : false;

if (expr != null) {
  print("expr is not null.\n");
} else {
  print("epxr is null.\n");
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for Velocity
#if($obj)
  #set($flag = true)
#else
  #set($flag = false)
#end
#if(! $expr)
expr is not null.
#else
epxr is null.
#end
</pre>
<br>


<a name="pl-variable"></a>
<h3 class="section2">変数</h3>
<p>変数はアルファべットまたは「_」で始まり、アルファベットと数字と「<code>_</code>」が連続したものです。
</p>
<p>また変数には型がなく、変数宣言もする必要がありません<sup>(<a href="#fnref:1" name="fnlink:1">*1</a>)</sup>。
</p>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:1" href="#fnlink:1">*1</a>)</dt>
  <dd>この性質から、PLまたはPL-Kwartzで書かれたプログラムを、変数に型のある言語や変数宣言が必要な言語に変換するのは困難です。</dd>
 </dl>
</div>
<br>


<a name="pl-op"></a>
<h3 class="section2">演算子</h3>
<p>演算子には次のものが使用できます。基本的には、文字列用と数値用とで演算子を分けてはいません<sup>(<a href="#fnref:2" name="fnlink:2">*2</a>)</sup>。
</p>
<div align="center">
<table class="table1" border="1" cellspacing="0" summary="	演算子
">
 <caption class="caption1">
	演算子
 </caption>
 <tr class="tr1">
  <td class="td1">比較演算子</td>
  <td class="td1"><code>==  != &lt; &lt;= &gt; &gt;=</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">論理演算子</td>
  <td class="td1"><code>&amp;&amp; || !</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">算術演算子</td>
  <td class="td1"><code>+ - * / %</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">文字列の連結</td>
  <td class="td1"><code> .+ </code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">条件演算子</td>
  <td class="td1"><code>?:</code></td>
 </tr>
</table>
</div>
<p>文字列の連結演算子「<code>.+</code>」は、eRubyでは「<code>+</code>」に、PHPでは「<code>.</code>」に、
JSTL1.1では関数<code>fn:join()</code>に変換されます。
JSTL1.0では連結演算子がないので、トリッキーな方法で凌いでいます。
Velocityではエラーになります。
</p>
<p>PLプログラム(PL)：
</p>
<a name="pl-concatop.plogic"></a>
<pre class="program">filename = basename .+ '.plogic';
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% filename = basename + ".plogic" %&gt;

### for PHP
&lt;?php $filename = $basename . ".plogic"; ?&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;c:set var="filename" value="${fn:join(basename,'.plogic')}"/&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:set var="filename" value="${basename}${'.plogic'}"/&gt;
</pre>
<p>条件演算子（3項演算子）はeRubyとPHPとJSTL1.1では使用できますが、JSTL1.0とVelocityでは使用できません。
そのため条件演算子を含む式は、JSTL1.0とVelocityではif文（JSTL1.0ならif文に相当する&lt;c:choose&gt;）に変換されます。
</p>
<p>PLプログラム(PL)：
</p>
<a name="pl-condop.plogic"></a>
<pre class="program">color = ctr % 2 == 0 ? '#FFCCCC' : '#CCCCFF';
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% color = ctr % 2 == 0 ? "#FFCCCC" : "#CCCCFF" %&gt;

### for PHP
&lt;?php $color = $ctr % 2 == 0 ? "#FFCCCC" : "#CCCCFF"; ?&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;c:set var="color" value="${ctr % 2 eq 0 ? '#FFCCCC' : '#CCCCFF'}"/&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:choose&gt;&lt;c:when test="${ctr % 2 eq 0}"&gt;
  &lt;c:set var="color" value="#FFCCCC"/&gt;
&lt;/c:when&gt;&lt;c:otherwise&gt;
  &lt;c:set var="color" value="#CCCCFF"/&gt;
&lt;/c:otherwise&gt;&lt;/c:choose&gt;

### for Velocity
#if($ctr % 2 == 0)
  #set($color = "#FFCCCC")
#else
  #set($color = "#CCCCFF")
#end
</pre>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:2" href="#fnlink:2">*2</a>)</dt>
  <dd>Perlのように文字列用と数値用とで演算子が異なる言語に対しては、Kwartzを対応させるのは困難です。</dd>
 </dl>
</div>
<br>


<a name="pl-print"></a>
<h3 class="section2">出力</h3>
<p>出力は「<code>print(<em>...</em>);</code>」で表します。
引数には任意の式を書くことができます。
</p>
<p>PLプログラム：
</p>
<a name="pl-print.plogic"></a>
<pre class="program">print('foo', bar, "baz\n");    // 文字列と変数を出力
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
foo&lt;%= bar %&gt;baz

### for PHP
foo&lt;?php echo $bar; ?&gt;baz

### for JSTL
foo&lt;c:out value="${bar}" escapeXml="false"/&gt;baz

### for Velocity
foo$!{bar}baz
</pre>
<p>自動サニタイズ機能を使用した場合は次のような出力になります。
</p>
<pre class="output">### for eRuby
foo&lt;%= CGI::escapeHTML((bar).to_s) %&gt;baz

### for PHP
foo&lt;?php echo htmlspecialchars($bar); ?&gt;baz

### for JSTL
foo&lt;c:out value="${bar}"/&gt;baz

### for Velocity
foo$!esc.html($bar)baz
</pre>
<p>また自動サニタイズ機能を使用しても、条件演算子が返す値が文字列または数字である場合は、サニタイズされません。
</p>
<p>PLプログラム：
</p>
<a name="pl-print2.plogic"></a>
<pre class="program">// サニタイズされる
print("&lt;option ", condition ? var1 : var2, "&gt;\n");
// サニタイズされない（必要がないから）
print("&lt;option ", condition ? 'selected' : '', "&gt;\n");
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;option &lt;%= CGI::escapeHTML((condition ? var1 : var2).to_s) %&gt;&gt;
&lt;option &lt;%= condition ? "selected" : "" %&gt;&gt;

### for PHP
&lt;option &lt;?php echo htmlspecialchars($condition ? $var1 : $var2); ?&gt;&gt;
&lt;option &lt;?php echo $condition ? "selected" : ""; ?&gt;&gt;

### for JSTL
&lt;option &lt;c:out value="${condition ? var1 : var2}"/&gt;&gt;
&lt;option &lt;c:out value="${condition ? 'selected' : ''}" escapeXml="false"/&gt;&gt;
</pre>
<p>「<code>print(a .+ b .+ c);</code>」は「<code>print(a); print(b); print(c);</code>」と展開されます。
これは、文字列の連結演算子「<code>.+</code>」をサポートしていない一部の言語を考慮した仕様です。
</p>
<br>


<a name="pl-assign"></a>
<h3 class="section2">代入</h3>
<p>代入は「<code>var = 100;</code>」のように行います。
また、「<code>+=</code>」「<code>-=</code>」「<code>*=</code>」「<code>/=</code>」「<code>%=</code>」「<code>.=</code>」も使用できます。
</p>
<p>PLプログラム：
</p>
<a name="pl-set.plogic"></a>
<pre class="program">name = 'Foo';		// 文字列を代入
count += 1;		// 値を1増やす
str .+= '.txt';		// 文字列の末尾に追加
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for PHP
&lt;?php $name = "Foo"; ?&gt;
&lt;?php $count += 1; ?&gt;
&lt;?php $str .= ".txt"; ?&gt;

### for eRuby
&lt;% name = "Foo" %&gt;
&lt;% count += 1 %&gt;
&lt;% str += ".txt" %&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;c:set var="name" value="Foo"/&gt;
&lt;c:set var="count" value="${count + 1}"/&gt;
&lt;c:set var="str" value="${fn:join(str,'.txt')}"/&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:set var="name" value="Foo"/&gt;
&lt;c:set var="count" value="${count + 1}"/&gt;
&lt;c:set var="str" value="${str}${'.txt'}"/&gt;
</pre>
<br>


<a name="pl-array"></a>
<h3 class="section2">配列、ハッシュ</h3>
<p>配列は「<code>arr[expr]</code>」の形で参照できます。
ハッシュも同じ形で参照できます<sup>(<a href="#fnref:3" name="fnlink:3">*3</a>)</sup>。
</p>
<p>JSTLでは配列やハッシュの要素を参照することはできますが、配列やハッシュの要素に代入することはできません。
</p>
<p>PLプログラム：
</p>
<a name="pl-array.plogic"></a>
<pre class="program">list[n] = 10;           // n番目の要素に代入
print(list[i], "\n");   // i番目の要素を出力
hash['key'] = 'foo';    // ハッシュの要素に代入
print(hash['key'], "\n"); // ハッシュの要素を出力
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% list[n] = 10 %&gt;
&lt;%= list[i] %&gt;
&lt;% hash["key"] = "foo" %&gt;
&lt;%= hash["key"] %&gt;

### for PHP
&lt;?php $list[$n] = 10; ?&gt;
&lt;?php echo $list[$i]; ?&gt;
&lt;?php $hash["key"] = "foo"; ?&gt;
&lt;?php echo $hash["key"]; ?&gt;
</pre>
<p>ハッシュは、「<code>hash[:key]</code>」という形でも参照できます。
このとき、「<code>key</code>」は英数字と「<code>_</code>」のみからなる文字列である必要があります。
</p>
<p>「<code>hash[:key]</code>」は、各プログラム言語に応じて次のように変換されます。
</p>
<div align="center">
<table class="table1" border="1" cellspacing="0" summary="	「<code>hash[:key]</code>」の変換結果
">
 <caption class="caption1">
	「<code>hash[:key]</code>」の変換結果
 </caption>
 <tr class="tr1">
  <th class="th1">ターゲット言語</th>
  <th class="th1">変換結果</th>
 </tr>
 <tr class="tr1">
  <td class="td1">eRuby</td>
  <td class="td1"><code>hash[:key]</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">PHP</td>
  <td class="td1"><code>$hash['key']</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">JSTL</td>
  <td class="td1"><code>hash['key']</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1">Velocity</td>
  <td class="td1"><code>hash.key</code></td>
 </tr>
</table>
</div>
<p>PLプログラム：
</p>
<a name="pl-hash.plogic"></a>
<pre class="program">print(hash[:key]);
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;%= hash[:key] %&gt;

### for PHP
&lt;?php echo $hash['key']; ?&gt;

### for JSTL
&lt;c:out value="${hash['key']}" escapeXml="false"/&gt;

### for Velocity
$!{hash.key}</pre>
<div class="footnote">
 <dl compact>
  <dt>(<a name="fnref:3" href="#fnlink:3">*3</a>)</dt>
  <dd>配列とハッシュとで同じ演算子を用いているため、Perlのように異なる演算子を必要とするプログラミング言語への変換は困難です。</dd>
 </dl>
</div>
<br>


<a name="pl-property"></a>
<h3 class="section2">プロパティとメソッド</h3>
<p>オブジェクトのプロパティは、「<code><em>object</em>.<em>property</em></code>」の形式で参照します。
また「<code><em>object</em>.<em>method</em>(<em>arg1</em>, <em>arg2</em>, ..)</code>」のように引数をつけてメソッドを呼ぶこともできます。
ただし、メソッド呼び出しはJSTLではサポートしてませんので、JSTLへの変換時にはエラーになります。
</p>
<p>PLプログラム：
</p>
<a name="pl-property.plogic"></a>
<pre class="program">// property
user.name = 'Foo';
print(user.name, "\n");
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% user.name = "Foo" %&gt;
&lt;%= user.name %&gt;

### for PHP
&lt;?php $user-&gt;name = "Foo"; ?&gt;
&lt;?php echo $user-&gt;name; ?&gt;

### for JSTL
&lt;c:set var="user" property="name" value="Foo"/&gt;
&lt;c:out value="${user.name}" escapeXml="false"/&gt;

### for Velocity
#set($user.name = "Foo")
$!{user.name}
</pre>
<p>PLプログラム：
</p>
<a name="pl-method.plogic"></a>
<pre class="program">// method call
print(user.method(10, 20));
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;%= user.method(10, 20) %&gt;

### for PHP
&lt;?php echo $user-&gt;method(10, 20); ?&gt;

### for Velocity
$!{user.method(10, 20)}</pre>
<p>またPLではオブジェクトやプロパティを参照することはできても、オブジェクトを自分で生成したりクラスを定義したりすることはできません。
それらはPLの外部で（つまりメインプログラムの中で）行われることになります。
</p>
<br>


<a name="pl-foreach"></a>
<h3 class="section2">繰り返し</h3>
<p>繰り返しは「<code>foreach(<em>loopvar</em> in <em>list</em>) { ... }</code>」で表します。
いわゆるforeach文であり、<code><em>list</em></code>の要素をひとつひとつ<code><em>loopvar</em></code>に代入しながら繰り返しを行います。
</p>
<p>PLプログラム：
</p>
<a name="pl-foreach.plogic"></a>
<pre class="program">foreach(item in list) {     // listの要素をitemに代入しながら
  print(item, "\n");        // 繰り返し出力する
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% for item in list do %&gt;
&lt;%= item %&gt;
&lt;% end %&gt;

### for PHP
&lt;?php foreach ($list as $item) { ?&gt;
&lt;?php echo $item; ?&gt;
&lt;?php } ?&gt;

### for JSTL
&lt;c:forEach var="item" items="${list}"&gt;
&lt;c:out value="${item}" escapeXml="false"/&gt;
&lt;/c:forEach&gt;

### for Velocity
#foreach($item in $list)
$!{item}
#end
</pre>
<p>またwhile文も使用できます。
ただし、JSTLおよびVelocityにはwhile文に相当するカスタムタグやディレクティブがないため、
JSTLまたはVelocityへ変換しようとするとエラーになります。
</p>
<p>PLプログラム：
</p>
<a name="pl-while.plogic"></a>
<pre class="program">i = 0;
while(i &lt; length) {
  i += 1;
  print(list[i]);
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% i = 0 %&gt;
&lt;% while i &lt; length do %&gt;
&lt;%   i += 1 %&gt;
&lt;%= list[i] %&gt;&lt;% end %&gt;

### for PHP
&lt;?php $i = 0; ?&gt;
&lt;?php while ($i &lt; $length) { ?&gt;
&lt;?php   $i += 1; ?&gt;
&lt;?php echo $list[$i]; ?&gt;&lt;?php } ?&gt;
</pre>
<p>なおJavaやCのようなfor文は用意されていません。ご注意ください。
</p>
<br>


<a name="pl-if"></a>
<h3 class="section2">条件分岐</h3>
<p>条件分岐は「<code>if(<em>condition</em>) { ... } else if(<em>condition</em>) { ... } else { ... }</code>」で表します。
</p>
<p>PLプログラム：
</p>
<a name="pl-if.plogic"></a>
<pre class="program">if (val &gt; 0) {
  print ("* value is positive.\n");
} else if (val &lt; 0) {
  print ("* value is negative.\n");
} else {
  print ("* value is zero.\n");
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% if val &gt; 0 then %&gt;
* value is positive.
&lt;% elsif val &lt; 0 then %&gt;
* value is negative.
&lt;% else %&gt;
* value is zero.
&lt;% end %&gt;

### for PHP
&lt;?php if ($val &gt; 0) { ?&gt;
* value is positive.
&lt;?php } elseif ($val &lt; 0) { ?&gt;
* value is negative.
&lt;?php } else { ?&gt;
* value is zero.
&lt;?php } ?&gt;

### for JSTL
&lt;c:choose&gt;&lt;c:when test="${val gt 0}"&gt;
* value is positive.
&lt;/c:when&gt;&lt;c:when test="${val lt 0}"&gt;
* value is negative.
&lt;/c:when&gt;&lt;c:otherwise&gt;
* value is zero.
&lt;/c:otherwise&gt;&lt;/c:choose&gt;

### for Velocity
#if($val &gt; 0)
* value is positive.
#elseif($val &lt; 0)
* value is negative.
#else
* value is zero.
#end
</pre>
<br>


<a name="pl-func"></a>
<h3 class="section2">関数</h3>
<p>PLでは、以下の関数を使用することができます。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
E(<em>expr</em>) </strong></dt>
<dd class="dd3">
	式 <em>expr</em> をサニタイズします。サニタイズはコマンドラインオプションの指定に関わらず行われます。
	E()は擬似関数であり、実際にはprint文の引数でしか使用できません。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
X(<em>expr</em>) </strong></dt>
<dd class="dd3">
	式 expr をサニタイズしません。つまりコマンドラインオプションでサニタイズするよう指定されていても、
	X(<em>expr</em>)で指定された式はサニタイズされません。
	X()は擬似関数であり、実際にはprint文の引数でしか使用できません。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
C(<em>expression</em>) </strong></dt>
<dd class="dd3">
	「<code><em>expression</em> ? ' checked="checked"' : ''</code>」と同じです。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
S(<em>expression</em>) </strong></dt>
<dd class="dd3">
	「<code><em>expression</em> ? ' selected="selected"' : ''</code>」と同じです。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
D(<em>expression</em>) </strong></dt>
<dd class="dd3">
	「<code><em>expression</em> ? ' disabled="disabled"' : ''</code>」と同じです。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
list_new() </strong></dt>
<dd class="dd3">
	  新しいリストを作成します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
list_length(<em>list</em>) </strong></dt>
<dd class="dd3">
	  リスト<em>list</em>の長さを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
list_empty(<em>list</em>) </strong></dt>
<dd class="dd3">
	  リスト<em>list</em>が空ならtrueを、空でないならfalseを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
hash_new() </strong></dt>
<dd class="dd3">
	  新しいハッシュを作成します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
hash_length(<em>hash</em>) </strong></dt>
<dd class="dd3">
	  ハッシュ<em>hash</em>の長さ（要素の数）を返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
hash_empty(<em>hash</em>) </strong></dt>
<dd class="dd3">
	  ハッシュ<em>hash</em>が空ならtrueを、空でないならfalseを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
hash_keys(<em>hash</em>) </strong></dt>
<dd class="dd3">
	  ハッシュの全キーをリストで返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_length(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>の長さを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_empty(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>が空ならtrueを、空でないならfalseを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_tolower(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>を小文字にして返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_toupper(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>を大文字にして返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_trim(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>の前後から空白を取り除いた文字列を返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_index(<em>string</em>, <em>char</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>において文字<em>char</em>のある場所を返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_replace(<em>string</em>, <em>before</em>, <em>after</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>において、文字列<em>before</em>を文字列<em>after</em>に置き換えたものを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
str_linebreak(<em>string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>string</em>において、改行のまえに<code>&lt;br /&gt;</code>を挿入したものを返します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
escape_xml(<em>html_string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>html_string</em>をサニタイズします。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
escape_url(<em>url_string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>url_string</em>をURL形式でエンコードします。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
escape_sql(<em>sql_string</em>) </strong></dt>
<dd class="dd3">
	  文字列<em>sql_string</em>中の「<code>'</code>」「<code>"</code>」「<code>\</code>」をバックスラッシュでエスケープします。
</dd>
</dl>
<p>どのように変換されるかは次をご覧ください。
</p>
<div align="center">
<table class="table1" border="1" cellspacing="0">
 <tr class="tr1">
  <th class="th1">関数名</th>
  <th class="th1">eRuby, ERB</th>
  <th class="th1">PHP</th>
  <th class="th1">JSTL1.1</th>
  <th class="th1">Velocity</th>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>list_new()</code></td>
  <td class="td1"><code>[]</code></td>
  <td class="td1"><code>array()</code></td>
  <td class="td1">-</td>
  <td class="td1">-</td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>list_length(<em>list</em>)</code></td>
  <td class="td1"><code><em>list</em>.length</code></td>
  <td class="td1"><code>array_length(<em>list</em>)</code></td>
  <td class="td1"><code>fn:length(<em>list</em>)</code></td>
  <td class="td1"><code>(<em>list</em>).size()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>list_empty(<em>list</em>)</code></td>
  <td class="td1"><code><em>list</em>.empty?</code></td>
  <td class="td1"><code>array_length(<em>list</em>)==0</code></td>
  <td class="td1"><code>fn:length(<em>list</em>)==0</code></td>
  <td class="td1"><code>(<em>list</em>).size()==0</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>hash_new()</code></td>
  <td class="td1"><code>{}</code></td>
  <td class="td1"><code>array()</code></td>
  <td class="td1">-</td>
  <td class="td1">-</td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>hash_length(<em>hash</em>)</code></td>
  <td class="td1"><code><em>hash</em>.length</code></td>
  <td class="td1"><code>array_length(<em>hash</em>)</code></td>
  <td class="td1"><code>fn:length(<em>hash</em>)</code></td>
  <td class="td1"><code><em>hash</em>.size()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>hash_empty(<em>hash</em>)</code></td>
  <td class="td1"><code><em>hash</em>.empty?</code></td>
  <td class="td1"><code>array_length(<em>hash</em>)==0</code></td>
  <td class="td1"><code>fn:length(<em>hash</em>)==0</code></td>
  <td class="td1"><code><em>hash</em>.size()==0</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>hash_keys(<em>hash</em>)</code></td>
  <td class="td1"><code><em>hash</em>.keys</code></td>
  <td class="td1"><code>array_keys(<em>hash</em>)</code></td>
  <td class="td1">-</td>
  <td class="td1"><code><em>hash</em>.keySet().toArray()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_length(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.lenth</code></td>
  <td class="td1"><code>strlen(<em>str</em>)</code></td>
  <td class="td1"><code>fn:length(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.length()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_tolower(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.downcase</code></td>
  <td class="td1"><code>strtolower(<em>str</em>)</code></td>
  <td class="td1"><code>fn:toLowerCase(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.toLowerCase()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_toupper(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.upcase</code></td>
  <td class="td1"><code>strtoupper(<em>str</em>)</code></td>
  <td class="td1"><code>fn:toUpperCase(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.toUpperCase()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_index(<em>str</em>,<em>ch</em>)</code></td>
  <td class="td1"><code><em>str</em>.index(<em>ch</em>)</code></td>
  <td class="td1"><code>strchr(<em>str</em>,<em>ch</em>)</code></td>
  <td class="td1"><code>fn:indexOf(<em>str</em>,<em>ch</em>)</code></td>
  <td class="td1"><code><em>str</em>.indexOf(<em>ch</em>)</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_replace(<em>str</em>,<em>before</em>, <em>after</em>)</code></td>
  <td class="td1"><code><em>str</em>.gsub(<em>before</em>,<em>after</em>)</code></td>
  <td class="td1"><code>str_replace(<em>before</em>,<em>after</em>,<em>str</em>)</code></td>
  <td class="td1"><code>fn:replace(<em>str</em>,<em>before</em>,<em>after</em>)</code></td>
  <td class="td1"><code><em>str</em>.indexOf(<em>ch</em>)</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>str_linebreak(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.gsub(/\r?\n/,'&lt;br /&gt;\&amp;')</code></td>
  <td class="td1"><code>nl2br(<em>str</em>)</code></td>
  <td class="td1"><code>fn:replace(<em>str</em>,'\n','&lt;br /&gt;\n')</code></td>
  <td class="td1"><code><em>str</em>.replaceAll('$','&lt;br /&gt;')</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>escape_xml(<em>str</em>)</code></td>
  <td class="td1"><code>CGI::escapeHTML(<em>str</em>)</code> (when eRuby) <br> <code>html_escape(<em>str</em>)</code> (when ERB)</td>
  <td class="td1"><code>htmlspecialchars(<em>str</em>)</code></td>
  <td class="td1"><code>fn:escapeXml(<em>str</em>)</code></td>
  <td class="td1"><code>$esc.xml(<em>str</em>)</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>escape_url(<em>str</em>)</code></td>
  <td class="td1"><code>CGI::escape(<em>str</em>)</code> (when eRuby) <br> <code>url_encode(<em>str</em>)</code> (when ERB)</td>
  <td class="td1"><code>urlencode(<em>str</em>)</code></td>
  <td class="td1">-</td>
  <td class="td1"><code>$link.setURI(<em>str</em>).toString()</code></td>
 </tr>
 <tr class="tr1">
  <td class="td1"><code>escape_sql(<em>str</em>)</code></td>
  <td class="td1"><code><em>str</em>.gsub(/['"\\\0]/,'\\\&amp;')</code></td>
  <td class="td1"><code>addslashes(<em>str</em>)</code></td>
  <td class="td1">-</td>
  <td class="td1"><code>$esc.sql(<em>str</em>)</code></td>
 </tr>
</table>
</div>
<p>これら以外の関数が指定されたときは、次のように動作します。
</p>
<ul type="disc">
<li>eRubyまたはPHPに変換するときはそのまま出力されます。
</li>
<li>JSTLとVelocityに変換するときは、エラーとなります。
</li>
</ul>
<p>E()とX()は、print文の引数として使われることを想定しています。
それ以外の場所では使わないでください。
</p>
<p>Velocityでは、以下の関数を使うために<a href="http://jakarta.apache.org/velocity/tools/">VelocityTools</a>をインストールする必要があります。
</p>
<ul type="disc">
<li><code>escape_xml()</code>と<code>escape_sql()</code>では<a href="http://wiki.apache.org/jakarta-velocity/EscapeTool">EscapeTools</a>を使用します。
</li>
<li><code>escape_url()</code>では<a href="http://jakarta.apache.org/velocity/tools/view/LinkTool.html">LinkTools</a>を使用します。
</li>
</ul>
<p>詳細はそれぞれのドキュメントを参照してください。
</p>
<br>


<a name="pl-empty"></a>
<h3 class="section2">empty</h3>
<p>値がnullまたは空文字列かどうかを調べるための予約語「<code>empty</code>」を用意しています。
「<code>empty</code>」は「<code>==</code>」または「<code>!=</code>」の右辺にのみ置くことができ、左辺がnullか空文字列なら真を、それ以外なら偽を返します。
</p>
<p>PLプログラム：
</p>
<a name="pl-empty.plogic"></a>
<pre class="program">if (str1 == empty) {
  print("str1 is empty.\n");
} else if (str2 != empty) {
  print("str2 is not empty.\n");
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% if !str1 || str1.empty? then %&gt;
str1 is empty.
&lt;% elsif str2 &amp;&amp; !str2.empty? then %&gt;
str2 is not empty.
&lt;% end %&gt;

### for PHP
&lt;?php if (!$str1) { ?&gt;
str1 is empty.
&lt;?php } elseif ($str2) { ?&gt;
str2 is not empty.
&lt;?php } ?&gt;

### for JSTL
&lt;c:choose&gt;&lt;c:when test="${empty str1}"&gt;
str1 is empty.
&lt;/c:when&gt;&lt;c:when test="${not empty str2}"&gt;
str2 is not empty.
&lt;/c:when&gt;&lt;/c:choose&gt;

### for Velocity
#if(! $str1 || $str1 == "")
str1 is empty.
#elseif($str2 &amp;&amp; $str2 != "")
str2 is not empty.
#end
</pre>
<br>


<a name="pl-decl"></a>
<h3 class="section2">エレメント宣言</h3>
<p>エレメント宣言とは、「<code>id="<em>name</em>"</code>」または「<code>id="mark:<em>name</em>"</code>」でマーキングされたエレメントに対して、属性を操作したり、プレゼンテーションロジックを変更するための記述です。
Kwartzでは、プレゼンテーションロジックファイルはエレメント宣言の集合として記述されます。
</p>
<p>エレメント宣言は、「<code>#<em>name</em></code>」および複数の宣言部から構成されます。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
<code>value: <em>expression</em>;</code> </strong></dt>
<dd class="dd3">
	エレメントの内容を式<code><em>expression</em></code>の値で置き換えます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>attrs: "<em>attr1</em>" <em>expr1</em> , "<em>attr2</em>" <em>expr2</em> , ... ;</code> </strong></dt>
<dd class="dd3">
	属性<code><em>attr</em></code>の値を式<code><em>expr</em></code>で置き換えます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>remove: "<em>attr1</em>" , "<em>attr2</em>" , ... ;</code> </strong></dt>
<dd class="dd3">
	属性<code><em>attr</em></code>を削除します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>append: <em>expr1</em> , <em>expr2</em> , ... ;</code> </strong></dt>
<dd class="dd3">
	タグに式<code><em>expr</em></code>の値を追加します。
	&lt;input&gt;タグや&lt;option&gt;タグにおいて「<code>checked</code>」や「<code>selected</code>」を追加するときに使用します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>tagname: <em>expression</em>;</code> </strong></dt>
<dd class="dd3">
	タグの名前を式<code><em>expression</em></code>で置き換えます。
	StrutsやJSFのカスタムタグを利用するときに使用します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>plogic: { <em>...</em> }</code> </strong></dt>
<dd class="dd3">
	プレゼンテーションロジックを記述します。
	<code>{ ... }</code> の中では <code>@stag</code>、<code>@cont</code>、<code>@etag</code> が使用でき、それぞれ開始タグ、内容、終了タグを表します。
	また <code>@element(<em>other</em>)</code> も使用でき、これはほかの名前がつけられたエレメントを展開することを表します。
</dd>
</dl>
<p>プレゼンテーションデータ：
</p>
<a name="pl-decl.pdata"></a>
<pre class="program">&lt;ul&gt;
  &lt;li id="foo" class="foo"&gt;dummy&lt;/li&gt;
&lt;/ul&gt;

&lt;form action="foo.cgi"&gt;
  &lt;input type="checkbox" name="user" value="Y" checked="checked" id="mark:chkbox"/&gt;
&lt;/form&gt;
</pre>
<p>プレゼンテーションロジック：
</p>
<a name="pl-decl.plogic"></a>
<pre class="program">#foo {
  value:  item;
  attrs:  "class" klass;
  plogic: {
    foreach (item in list) {
      @stag;
      @cont;
      @etag;
    }
  }
}
#chkbox {
  remove:  "checked";
  append:  flag ? " checked" : "";
  tagname: "html:text";
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;ul&gt;
&lt;% for item in list do %&gt;
  &lt;li id="foo" class="&lt;%= klass %&gt;"&gt;&lt;%= item %&gt;&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;

&lt;form action="foo.cgi"&gt;
  &lt;html:text type="checkbox" name="user" value="Y"&lt;%= flag ? " checked" : "" %&gt; /&gt;
&lt;/form&gt;

### for PHP
&lt;ul&gt;
&lt;?php foreach ($list as $item) { ?&gt;
  &lt;li id="foo" class="&lt;?php echo $klass; ?&gt;"&gt;&lt;?php echo $item; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;/ul&gt;

&lt;form action="foo.cgi"&gt;
  &lt;html:text type="checkbox" name="user" value="Y"&lt;?php echo $flag ? " checked" : ""; ?&gt; /&gt;
&lt;/form&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;ul&gt;
&lt;c:forEach var="item" items="${list}"&gt;
  &lt;li id="foo" class="&lt;c:out value="${klass}" escapeXml="false"/&gt;"&gt;&lt;c:out value="${item}" escapeXml="false"/&gt;&lt;/li&gt;
&lt;/c:forEach&gt;
&lt;/ul&gt;

&lt;form action="foo.cgi"&gt;
  &lt;html:text type="checkbox" name="user" value="Y"&lt;c:out value="${flag ? ' checked' : ''}" escapeXml="false"/&gt; /&gt;
&lt;/form&gt;

### for Velocity
&lt;ul&gt;
#foreach($item in $list)
  &lt;li id="foo" class="$!{klass}"&gt;$!{item}&lt;/li&gt;
#end
&lt;/ul&gt;

&lt;form action="foo.cgi"&gt;
#if($flag)
  &lt;html:text type="checkbox" name="user" value="Y" checked /&gt;
#else
  &lt;html:text type="checkbox" name="user" value="Y" /&gt;
#end
&lt;/form&gt;
</pre>
<br>


<a name="pl-doc"></a>
<h3 class="section2">ドキュメント宣言</h3>
<p><code>#DOCUMENT { <em>...</em> }</code>は、ドキュメントのための特殊なエレメント宣言です。
この宣言はドキュメント全体の情報を表し、次の宣言部を使用します。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
<code>begin: { <em>...</em> }</code> </strong></dt>
<dd class="dd3">
	出力用スクリプトの先頭に、指定されたPLコードを追加します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>end: { <em>...</em> }</code> </strong></dt>
<dd class="dd3">
	出力用スクリプトの末尾に、指定されたPLコードを追加します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>require: "<em>filename1</em>" , "<em>filename2</em>", <em>...</em> ;</code> </strong></dt>
<dd class="dd3">
	プレゼンテーションロジックファイルを読み込みます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>global: <em>varname1</em> , <em>varname2</em> , <em>...</em> ;</code> </strong></dt>
<dd class="dd3">
	グローバル変数を列挙します。現在は何も使われていませんが、将来は使う予定です。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
<code>local: <em>varname1</em> , <em>varname2</em> , <em>...</em> ;</code> </strong></dt>
<dd class="dd3">
	ローカル変数を列挙します。現在は何も使われていませんが、将来は使う予定です。
</dd>
</dl>
<p>プレゼンテーションデータ：
</p>
<a name="pl-doc.html"></a>
<pre class="program">&lt;ul id="mark:list"&gt;
  &lt;li id="value:item"&gt;foo&lt;/li&gt;
&lt;/ul&gt;
</pre>
<p>PLプログラム：
</p>
<a name="pl-doc.plogic"></a>
<pre class="program">#DOCUMENT {
  begin: {
    list = context[:list];
  }
  end:   {
    print("&lt;!-- copyright(c) 2005 kuwata-lab.com ALL RIGHTS RESERVERD. --&gt;\n");
  }
  global:  context;
}

#list {
  plogic: {
    @stag;
    foreach (item in list)
      @cont;
    @etag;
  }
}
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% list = context[:list] %&gt;
&lt;ul&gt;
&lt;% for item in list do %&gt;
  &lt;li&gt;&lt;%= item %&gt;&lt;/li&gt;
&lt;% end %&gt;
&lt;/ul&gt;
&lt;!-- copyright(c) 2005 kuwata-lab.com ALL RIGHTS RESERVERD. --&gt;

### for PHP
&lt;?php $list = $context['list']; ?&gt;
&lt;ul&gt;
&lt;?php foreach ($list as $item) { ?&gt;
  &lt;li&gt;&lt;?php echo $item; ?&gt;&lt;/li&gt;
&lt;?php } ?&gt;
&lt;/ul&gt;
&lt;!-- copyright(c) 2005 kuwata-lab.com ALL RIGHTS RESERVERD. --&gt;

### for JSTL
&lt;c:set var="list" value="${context['list']}"/&gt;
&lt;ul&gt;
&lt;c:forEach var="item" items="${list}"&gt;
  &lt;li&gt;&lt;c:out value="${item}" escapeXml="false"/&gt;&lt;/li&gt;
&lt;/c:forEach&gt;
&lt;/ul&gt;
&lt;!-- copyright(c) 2005 kuwata-lab.com ALL RIGHTS RESERVERD. --&gt;

### for Velocity
#set($list = $context.list)
&lt;ul&gt;
#foreach($item in $list)
  &lt;li&gt;$!{item}&lt;/li&gt;
#end
&lt;/ul&gt;
&lt;!-- copyright(c) 2005 kuwata-lab.com ALL RIGHTS RESERVERD. --&gt;
</pre>
<br>


<a name="pl-rawcode"></a>
<h3 class="section2">ターゲット言語のプログラムコード</h3>
<p>ターゲット言語(Ruby,PHP,Javaなど)のプログラムコードを直接記述することもできます。
Kwartzではターゲット言語で書かれたコードをRawcodeと呼んでいます。
</p>
<ul type="disc">
<li>「<code>&lt;%=<em>expression</em>%&gt;</code>」または「<code>&lt;?=<em>expression</em>?&gt;</code>」は、ターゲット言語で書かれた式です。
   これはRawcode式(Rawcode Expression)といい、文法的には文字列や数字と同じようにリテラルとして扱われます。
</li>
<li>「<code>&lt;%<em>statement</em>%&gt;</code>」または「<code>&lt;?<em>statement</em>?&gt;</code>」は、ターゲット言語で書かれた文です。
   これはRawcode文(Rawcode Statement)といい、ひとつの文として扱われます。
   ただし行末の「<code>;</code>」は必要ありません。
</li>
</ul>
<p>次の例は、Rubyコードを直接記述した例です。
</p>
<p>PLプログラム：
</p>
<a name="pl-rawcode1.plogic"></a>
<pre class="program">// Rawcode式
hash = <strong>&lt;%= { :a =&gt; 123, :b =&gt; 456, :c =&gt; 789, } %&gt;</strong>;

// Rawcode文
<strong>&lt;% hash.each do |key, value| %&gt;</strong>
print("key=", key, " value=", value, "\n");
<strong>&lt;% end %&gt;</strong>
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% hash = { :a =&gt; 123, :b =&gt; 456, :c =&gt; 789, } %&gt;
&lt;% hash.each do |key, value| %&gt;
key=&lt;%= key %&gt; value=&lt;%= value %&gt;
&lt;% end %&gt;
</pre>
<p>次の例は、PHPのコードを直接記述した例です。
</p>
<p>PLプログラム：
</p>
<a name="pl-rawcode2.plogic"></a>
<pre class="program">// Rawcode式
hash = <strong>&lt;?= array("a"=&gt;123, "b"=&gt;456, "c"=&gt;789) ?&gt;</strong>;

// Rawcode文
<strong>&lt;?php foreach($hash as $key =&gt; $value) { ?&gt;</strong>
print("key=", key, " value=", value, "\n");
<strong>&lt;?php } ?&gt;</strong>
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for PHP
&lt;?php $hash = array("a"=&gt;123, "b"=&gt;456, "c"=&gt;789); ?&gt;
&lt;?php foreach($hash as $key =&gt; $value) { ?&gt;
key=&lt;?php echo $key; ?&gt; value=&lt;?php echo $value; ?&gt;
&lt;?php } ?&gt;
</pre>
<p>Rawcode文は、エレメント宣言の「plogic:」部に記述できます。
またRawcode式は、「value:」部や「attrs:」部に記述できます。
なおRawcode式を「<code>X(&lt;%= <em>...</em> %&gt;)</code>」のように記述すれば、サニタイズしません。
</p>
<p>Rawcodeを用いてKwartzをRuby on Railsで使うサンプルが、Kwartzアーカイブのexamples/rails1ディレクトリにあります。
参考にしてください。
</p>
<p>ターゲット言語のプログラムコードを直接記述した場合は、当然ですが他の言語では使用できなくなります。
それでも構わない場合にのみ使用してください。
</p>
<br>


<a name="pl-scope"></a>
<h3 class="section2">グローバル変数とローカル変数</h3>
<p>Kwartzでは、メインプログラムから出力用プログラムに渡される変数をテンプレートグローバル変数、テンプレートの中だけで使用される変数をテンプレートローカル変数と呼んでいます。
</p>
<p>例えば次のようなプレゼンテーションデータとプレゼンテーションロジックを考えます。
</p>
<p>プレゼンテーションデータ(analyze.html)：
</p>
<a name="analyze.html"></a>
<pre class="program">&lt;table&gt;
  &lt;caption id="value:<strong>title</strong>"&gt;Sample&lt;/caption&gt;
  &lt;tr id="mark:items" bgcolor="@{<strong>color</strong>}@"&gt;
    &lt;td id="value:<strong>item</strong>"&gt;Foo&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;
</pre>
<p>プレゼンテーションロジック(analyze.plogic)：
</p>
<a name="analyze.plogic"></a>
<pre class="program">#items {
  plogic: {
    <strong>ctr</strong> = 0;
    foreach (<strong>item</strong> in <strong>list</strong>) {
      <strong>ctr</strong> += 1;
      <strong>color</strong> = <strong>ctr</strong>%2 == 0 ? '#FFCCCC' : '#CCCCFF';
      @stag;
      @cont;
      @etag;
    }
  }
}
</pre>
<p>いくつかの変数がでてきますが、これらは次のように分類できます。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
テンプレートグローバル変数 </strong></dt>
<dd class="dd3">
	 変数「<code>title</code>」と「<code>list</code>」は、メインプログラムからテンプレートに渡される変数であり、メインプログラムで値を設定する必要があります。
	Kwartzではこれをテンプレートグローバル変数と呼んでいます。
</dd>
<dt class="dt3"><strong>
テンプレートローカル変数 </strong></dt>
<dd class="dd3">
	変数「<code>item</code>」と「<code>ctr</code>」と「<code>color</code>」はテンプレートの中だけで使用される変数であり、メインプログラムで設定する必要はありません。
	Kwartzではこれをテンプレートローカル変数と呼んでいます。
</dd>
</dl>
<p>kwartzコマンドにオプション「<code>-a analyze</code>」をつけて起動すると、テンプレートを分析してテンプレートグローバル変数とテンプレートローカル変数を報告してくれます。
</p>
<pre class="program">$ kwartz -p analyze.plogic -a analyze analyze.html
Global: <strong>title</strong> <strong>list</strong>
Local:  <strong>ctr</strong> <strong>item</strong> <strong>color</strong>
</pre>
<p>このとき、Kwartzは次のようなルールでグローバルかローカルかを判定しています。
</p>
<ul type="disc">
<li>変数が初めて現れたときに…
    <ul type="circle">
    <li>代入文の左辺に現れた変数はテンプレートローカル変数
    </li>
    <li>foreach文のループ変数として現れた変数はテンプレートローカル変数
    </li>
    <li>それ以外はテンプレートグローバル変数
    </li>
    </ul>
</li>
</ul>
<p>またテンプレートグローバル変数へ代入したり、テンプレートグローバル変数をループ変数としていると、分析時に警告を出します。
なぜなら、テンプレートシステムはメインプログラムで設定されたデータの表示のみを行うべきであり、それらを変更すべきではないから、つまりテンプレートグローバル変数を変更すべきではないからです（変更してよいのはテンプレートローカル変数のみのはずです）。
</p>
<p>テンプレート（プレゼンテーションデータとプレゼンテーションロジック）が複雑になると、メインプログラムで設定しなければならない変数がどれか、わかりづらくなることがあります。
そのようなときは、この分析機能を利用してください。変数名のタイプミスも見つけやすくなります。
</p>
<br>


<a name="pl-infuture"></a>
<h3 class="section2">未実装（または検討中）の機能</h3>
<p>以下の機能は実装されていませんが、将来において実装されるかもしれません。
</p>
<ul type="disc">
<li>break, continue
</li>
<li>ユーザ定義関数
</li>
<li>JSTLにおける配列やハッシュの作成
</li>
</ul>
<br>


<br>


<a name="kd"></a>
<h2 class="section1">ディレクティブ</h2>
<a name="kd-whatis"></a>
<h3 class="section2">ディレクティブとは？</h3>
<p>Kwartzでは、プレゼンテーションデータの中にプレゼンテーションロジックを埋め込むこともできます。
そのための命令を「ディレクティブ(Directive)」といいます。
</p>
<p>ディレクティブとは、プレゼンテーションデータの中にプレゼンテーションロジックを埋め込むための命令です。
Kwartzでは、ディレクティブはid属性またはid属性を使用します（使い方はどちらも同じです）。
「<code>id="<em>name</em>"</code>」や「<code>id="mark:<em>name</em>"</code>」も、「マーキング」というディレクティブです。
</p>
<p>Kwartzではせっかくプレゼンテーションデータとプレゼンテーションロジックとを分離することができるのに、なぜ両者を一体化するような機能も用意されているのでしょう？
</p>
<p>それは、開発者の好みに応じてどちらも選べるようにするため、つまり「<strong>選択可能性(choosability)</strong>」を高めるためです。
Kwartzは、開発者にどちらか一方を押しつけるようなことはしません。
分離するほうが望ましいのであれば分離すればよいし、一体化するほうが好みであれば一体化すればよいのです。
</p>
<p>また両者を一体化すると、他のテンプレートと差別化できないと思われるかもしれません。
しかし一体化してもなお、Kwartzは他のテンプレートと比べて次のような利点があります。
</p>
<ul type="disc">
<li>HTMLデザインを崩しません（<a href="http://jakarta.apache.org/velocity/">Jakarta Velocity</a>や<a href="http://www.template-toolkit.org/">Template-Toolkit</a>と比べてみてください）。
</li>
<li>複雑なプログラミングが必要ありません（DOMプログラミングが必要な<a href="http://xmlc.objectweb.org/">Enhydra XMLC</a>と比べてみてください）。
</li>
<li>実行時の動作が軽くて高速です（<a href="http://amrita.sourceforge.jp/">amrita</a>と比べてみてください）。
</li>
<li>XMLやHTMLだけでなく、どのようなテキスト形式でも利用できます（<a href="http://xmlc.objectweb.org/">Enhydra XMLC</a>や<a href="http://amrita.sourceforge.jp/">amrita</a>と比べて見てください）。
</li>
<li>各種のプログラミング言語で使用できます（このようなテンプレートシステムは他にありません！）。
</li>
</ul>
<br>


<a name="kd-mark"></a>
<h3 class="section2">マーキング</h3>
<p>「<code>id="<em>name</em>"</code>」または「<code>id="mark:<em>name</em>"</code>」とすることで、マーキングを行います。
マーキングとは、エレメントに対してその名前で目印をつけることです。
</p>
<p>「<code>id="<em>name</em>"</code>」と「<code>id="mark:<em>name</em>"</code>」との違いは、コンパイルされると前者ではid属性が残るのに対し後者は取り除かれるという点です。
またkw:d属性は必ず取り除かれます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-mark.pdata"></a>
<pre class="program">&lt;div <strong>id="foo"</strong>&gt;foo&lt;/div&gt;
&lt;div <strong>id="mark:bar"</strong>&gt;bar&lt;/div&gt;
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;div id="foo"&gt;foo&lt;/div&gt;
&lt;div&gt;bar&lt;/div&gt;

### for PHP
&lt;div id="foo"&gt;foo&lt;/div&gt;
&lt;div&gt;bar&lt;/div&gt;

### for JSTL
&lt;div id="foo"&gt;foo&lt;/div&gt;
&lt;div&gt;bar&lt;/div&gt;

### for Velocity
&lt;div id="foo"&gt;foo&lt;/div&gt;
&lt;div&gt;bar&lt;/div&gt;
</pre>
<br>


<a name="kd-output"></a>
<h3 class="section2">値の出力</h3>
<p>「<code>@{<em>expression</em>}@</code>」は、式の値を出力するディレクティブです。
このパターンは、設定ファイルのEMBED_PATTERNに設定されています。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-output.html"></a>
<pre class="program">Hello <strong>@{user.name}@</strong>!
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
Hello &lt;%= user.name %&gt;!

### for PHP
Hello &lt;?php echo $user-&gt;name; ?&gt;!

### for JSTL
Hello &lt;c:out value="${user.name}" escapeXml="false"/&gt;!

### for Velocity
Hello $!{user.name}!
</pre>
<p>コンパイル時に、コマンドオプション<code>-e</code>を指定した場合は、式をサニタイズして出力します。
このとき、文字列や数値はサニタイズされず、式のみがサニタイズされることに注意してください。
</p>
<p>出力用プログラム（コマンドオプション<code>-e</code>をつけた場合）：
</p>
<pre class="output">### for eRuby
Hello &lt;%= CGI::escapeHTML((user.name).to_s) %&gt;!

### for PHP
Hello &lt;?php echo htmlspecialchars($user-&gt;name); ?&gt;!

### for JSTL
Hello &lt;c:out value="${user.name}"/&gt;!

### for Velocity
Hello $!esc.html($user.name)!
</pre>
<p>コマンドオプションの有無に関わらずサニタイズをする/しないを指定するには、関数<code>E()</code>と<code>X()</code>を使用します。
<code>E(<em>expr</em>)</code>は式<code><em>expr</em></code>をサニタイズし、<code>X(<em>expr</em>)</code>はサニタイズしません。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-output2.html"></a>
<pre class="program">With sanitizing:    <strong>@{E(var)}@</strong>!
Without sanitizing: <strong>@{X(var)}@</strong>!
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
With sanitizing:    &lt;%= CGI::escapeHTML((var).to_s) %&gt;!
Without sanitizing: &lt;%= var %&gt;!

### for PHP
With sanitizing:    &lt;?php echo htmlspecialchars($var); ?&gt;!
Without sanitizing: &lt;?php echo $var; ?&gt;!

### for JSTL
With sanitizing:    &lt;c:out value="${var}"/&gt;!
Without sanitizing: &lt;c:out value="${var}" escapeXml="false"/&gt;!

### for Velocity
With sanitizing:    $!esc.html($var)!
Without sanitizing: $!{var}!
</pre>
<p>.
.
</p>
<br>


<a name="kd-value"></a>
<h3 class="section2">値の出力2</h3>
<p>「<code>id="value:<em>expression</em>"</code>」とすることで、内容のかわりに式の値を出力します。
ダミーデータを利用できるため、「<code>@{<em>expression</em>}@</code>」と比べてHTMLデザインがより崩れません。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-value.html"></a>
<pre class="program">&lt;li <strong>id="value:hash['name']"</strong>&gt;foo&lt;/li&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;li&gt;&lt;%= hash["name"] %&gt;&lt;/li&gt;

### for PHP
&lt;li&gt;&lt;?php echo $hash["name"]; ?&gt;&lt;/li&gt;

### for JSTL
&lt;li&gt;&lt;c:out value="${hash['name']}" escapeXml="false"/&gt;&lt;/li&gt;

### for Velocity
&lt;li&gt;$!{hash["name"]}&lt;/li&gt;
</pre>
<p>また「<code>id="Value:<em>expr</em>"</code>」でサニタイズすることを、「<code>id="VALUE:<em>expr</em>"</code>」でサニタイズしないことを指定できます。
これらはそれぞれ「<code>id="value:E(<em>expr</em>)"</code>」や「<code>id="value:X(<em>expr</em>)"</code>」と同じです。
</p>
<br>


<a name="kd-attr"></a>
<h3 class="section2">属性値の設定</h3>
<p>「<code>id="attr:<em>name</em>=<em>value</em>"</code>」または「<code>id="attr:<em>name</em>:<em>value</em>"</code>」とすることで、タグの属性値を設定できます。
これを用いると、「<code>@{...}@</code>」を使わずに属性値を設定でき、またダミーの属性値を設定できます。
</p>
<p>次の例では、属性classにダミーの属性値 "<code>odd</code>" を設定していますが、実際には変数<code>klass</code>の値を用いるようにしています。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-attr.pdata"></a>
<pre class="program">&lt;tr class="odd" <strong>id="attr:class=klass"</strong>&gt;
  &lt;td&gt;foo&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;tr class="&lt;%= klass %&gt;"&gt;
  &lt;td&gt;foo&lt;/td&gt;
&lt;/tr&gt;

### for PHP
&lt;tr class="&lt;?php echo $klass; ?&gt;"&gt;
  &lt;td&gt;foo&lt;/td&gt;
&lt;/tr&gt;

### for JSTL
&lt;tr class="&lt;c:out value="${klass}" escapeXml="false"/&gt;"&gt;
  &lt;td&gt;foo&lt;/td&gt;
&lt;/tr&gt;

### for Velocity
&lt;tr class="$!{klass}"&gt;
  &lt;td&gt;foo&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>また「<code>id="Attr:<em>name</em>=<em>value</em>"</code>」でサニタイズすることを、「<code>id="ATTR:<em>name</em>=<em>value</em>"</code>」でサニタイズしないことを指定できます。
これらはそれぞれ「<code>id="attr:<em>name</em>=E(<em>value</em>)"</code>」や「<code>id="attr:<em>name</em>=X(<em>value</em>)"</code>」と同じです。
</p>
<p>なお「<code>;</code>」で区切ることにより、「<code>attr:<em>name</em>=<em>value</em></code>」を複数設定したり他のテンプレートコマンドと一緒に設定したりできます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-attr2.pdata"></a>
<pre class="program">&lt;font id="if:message!=empty<strong>;attr:class=klass;attr:bgcolor=color</strong>"&gt;
 @{message}@
&lt;/font&gt;
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">### for eRuby
&lt;% if message &amp;&amp; !message.empty? then %&gt;
&lt;font class="&lt;%= klass %&gt;" bgcolor="&lt;%= color %&gt;"&gt;
 &lt;%= message %&gt;
&lt;/font&gt;
&lt;% end %&gt;

### for PHP
&lt;?php if ($message) { ?&gt;
&lt;font class="&lt;?php echo $klass; ?&gt;" bgcolor="&lt;?php echo $color; ?&gt;"&gt;
 &lt;?php echo $message; ?&gt;
&lt;/font&gt;
&lt;?php } ?&gt;

### for JSTL
&lt;c:if test="${not empty message}"&gt;
&lt;font class="&lt;c:out value="${klass}" escapeXml="false"/&gt;" bgcolor="&lt;c:out value="${color}" escapeXml="false"/&gt;"&gt;
 &lt;c:out value="${message}" escapeXml="false"/&gt;
&lt;/font&gt;
&lt;/c:if&gt;

### for Velocity
#if($message &amp;&amp; $message != "")
&lt;font class="$!{klass}" bgcolor="$!{color}"&gt;
 $!{message}
&lt;/font&gt;
#end
</pre>
<br>


<a name="kd-append"></a>
<h3 class="section2">属性の追加</h3>
<p>「<code>id="append:<em>expression</em>"</code>」とすることで、タグの中に式の値を追加できます。
これは主に「&lt;input ... checked /&gt;」や「&lt;option ... selected&gt;&lt;/option&gt;」を実現するための機能です。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-append.pdata"></a>
<pre class="program">&lt;option name="lang" value="ruby"
       <strong>id="append:lang=='ruby'?' selected':''"</strong>&gt;Ruby&lt;/option&gt;
&lt;input type="radio" name="gender" value="M"
       <strong>id="append:gender=='M'?' checked':''"</strong>&gt;
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;option name="lang" value="ruby"&lt;%= lang == "ruby" ? " selected" : "" %&gt;&gt;Ruby&lt;/option&gt;
&lt;input type="radio" name="gender" value="M"&lt;%= gender == "M" ? " checked" : "" %&gt;&gt;

### for PHP
&lt;option name="lang" value="ruby"&lt;?php echo $lang == "ruby" ? " selected" : ""; ?&gt;&gt;Ruby&lt;/option&gt;
&lt;input type="radio" name="gender" value="M"&lt;?php echo $gender == "M" ? " checked" : ""; ?&gt;&gt;

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;option name="lang" value="ruby"&lt;c:out value="${lang eq 'ruby' ? ' selected' : ''}" escapeXml="false"/&gt;&gt;Ruby&lt;/option&gt;
&lt;input type="radio" name="gender" value="M"&lt;c:out value="${gender eq 'M' ? ' checked' : ''}" escapeXml="false"/&gt;&gt;

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:choose&gt;&lt;c:when test="${lang eq 'ruby'}"&gt;
&lt;option name="lang" value="ruby" selected&gt;&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;option name="lang" value="ruby"&gt;&lt;/c:otherwise&gt;&lt;/c:choose&gt;
Ruby&lt;/option&gt;
&lt;c:choose&gt;&lt;c:when test="${gender eq 'M'}"&gt;
&lt;input type="radio" name="gender" value="M" checked&gt;
&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;input type="radio" name="gender" value="M"&gt;
&lt;/c:otherwise&gt;&lt;/c:choose&gt;
</pre>
<p>なお「<code>checked="checked"</code>」「<code>selected="selected"</code>」「<code>disabled="disabled"</code>」の出力を簡単にするための機能として、関数「<code>C(<em>expr</em>)</code>」「<code>S(<em>expr</em>)</code>」「<code>D(<em>expr</em>)</code>」が用意されています。
これらは、式<code><em>expr</em></code>が真のときにそれぞれ「<code>checked="checked"</code>」「<code>selected="selected"</code>」「<code>disabled="disabled"</code>」を出力します。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-append2.pdata"></a>
<pre class="program">&lt;option name="lang" value="ruby"
       id="append:<strong>S(lang=='ruby')</strong>"&gt;Ruby&lt;/option&gt;

&lt;input type="radio" name="gender" value="M"
       id="append:<strong>C(gender=='M')</strong>" /&gt;Male

&lt;input type="radio" name="os" value="win"
       id="append:<strong>D(os=='mac')</strong>" /&gt;Windows
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for PHP
&lt;option name="lang" value="ruby"&lt;?php echo $lang == "ruby" ? " selected=\"selected\"" : ""; ?&gt;&gt;Ruby&lt;/option&gt;

&lt;input type="radio" name="gender" value="M"&lt;?php echo $gender == "M" ? " checked=\"checked\"" : ""; ?&gt; /&gt;Male

&lt;input type="radio" name="os" value="win"&lt;?php echo $os == "mac" ? " disabled=\"disabled\"" : ""; ?&gt; /&gt;Windows

### for eRuby
&lt;option name="lang" value="ruby"&lt;%= lang == "ruby" ? " selected=\"selected\"" : "" %&gt;&gt;Ruby&lt;/option&gt;

&lt;input type="radio" name="gender" value="M"&lt;%= gender == "M" ? " checked=\"checked\"" : "" %&gt; /&gt;Male

&lt;input type="radio" name="os" value="win"&lt;%= os == "mac" ? " disabled=\"disabled\"" : "" %&gt; /&gt;Windows

### for JSTL 1.1
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %&gt;
&lt;%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %&gt;
&lt;option name="lang" value="ruby"&lt;c:out value="${lang eq 'ruby' ? ' selected="selected"' : ''}" escapeXml="false"/&gt;&gt;Ruby&lt;/option&gt;

&lt;input type="radio" name="gender" value="M"&lt;c:out value="${gender eq 'M' ? ' checked="checked"' : ''}" escapeXml="false"/&gt; /&gt;Male

&lt;input type="radio" name="os" value="win"&lt;c:out value="${os eq 'mac' ? ' disabled="disabled"' : ''}" escapeXml="false"/&gt; /&gt;Windows

### for JSTL 1.0
&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;
&lt;c:choose&gt;&lt;c:when test="${lang eq 'ruby'}"&gt;
&lt;option name="lang" value="ruby" selected="selected"&gt;&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;option name="lang" value="ruby"&gt;&lt;/c:otherwise&gt;&lt;/c:choose&gt;
Ruby&lt;/option&gt;

&lt;c:choose&gt;&lt;c:when test="${gender eq 'M'}"&gt;
&lt;input type="radio" name="gender" value="M" checked="checked" /&gt;&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;input type="radio" name="gender" value="M" /&gt;&lt;/c:otherwise&gt;&lt;/c:choose&gt;
Male

&lt;c:choose&gt;&lt;c:when test="${os eq 'mac'}"&gt;
&lt;input type="radio" name="os" value="win" disabled="disabled" /&gt;&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;input type="radio" name="os" value="win" /&gt;&lt;/c:otherwise&gt;&lt;/c:choose&gt;
Windows
</pre>
<br>


<a name="kd-set"></a>
<h3 class="section2">変数への代入</h3>
<p>「<code>id="set:<em>var</em>=<em>value</em>"</code>」は、変数<em>var</em>に値<em>value</em>を設定します。
「<code>=</code>」だけでなく「<code>+=</code>」「<code>-=</code>」「<code>*=</code>」「<code>/=</code>」「<code>.=</code>」が使用できます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-set.pdata"></a>
<pre class="program">&lt;dt <strong>id="set:var=value"</strong>&gt;foo&lt;/dt&gt;
&lt;dd <strong>id="set:count+=1"</strong>&gt;123&lt;/dd&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;% var = value %&gt;
&lt;dt&gt;foo&lt;/dt&gt;
&lt;% count += 1 %&gt;
&lt;dd&gt;123&lt;/dd&gt;

### for PHP
&lt;?php $var = $value; ?&gt;
&lt;dt&gt;foo&lt;/dt&gt;
&lt;?php $count += 1; ?&gt;
&lt;dd&gt;123&lt;/dd&gt;

### for JSTL
&lt;c:set var="var" value="${value}"/&gt;
&lt;dt&gt;foo&lt;/dt&gt;
&lt;c:set var="count" value="${count + 1}"/&gt;
&lt;dd&gt;123&lt;/dd&gt;

### for Velocity
#set($var = $value)
&lt;dt&gt;foo&lt;/dt&gt;
#set($count = $count + 1)
&lt;dd&gt;123&lt;/dd&gt;
</pre>
<br>


<a name="kd-if"></a>
<h3 class="section2">条件分岐</h3>
<p>「<code>id="if:<em>expression</em>"</code>」とすることで、条件分岐を行います。
elseやelseifも使用できます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-if.pdata"></a>
<pre class="program">&lt;div <strong>id="if:value &gt; 0"</strong>&gt;
  Value is positive.
&lt;/div&gt;
&lt;div <strong>id="elseif:value &lt; 0"</strong>&gt;
  Value is negative.
&lt;/div&gt;
&lt;div <strong>id="else:"</strong>&gt;
  Value is zero.
&lt;/div&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;% if value &gt; 0 then %&gt;
&lt;div&gt;
  Value is positive.
&lt;/div&gt;
&lt;% elsif value &lt; 0 then %&gt;
&lt;div&gt;
  Value is negative.
&lt;/div&gt;
&lt;% else %&gt;
&lt;div&gt;
  Value is zero.
&lt;/div&gt;
&lt;% end %&gt;

### for PHP
&lt;?php if ($value &gt; 0) { ?&gt;
&lt;div&gt;
  Value is positive.
&lt;/div&gt;
&lt;?php } elseif ($value &lt; 0) { ?&gt;
&lt;div&gt;
  Value is negative.
&lt;/div&gt;
&lt;?php } else { ?&gt;
&lt;div&gt;
  Value is zero.
&lt;/div&gt;
&lt;?php } ?&gt;

### for JSTL
&lt;c:choose&gt;&lt;c:when test="${value gt 0}"&gt;
&lt;div&gt;
  Value is positive.
&lt;/div&gt;
&lt;/c:when&gt;&lt;c:when test="${value lt 0}"&gt;
&lt;div&gt;
  Value is negative.
&lt;/div&gt;
&lt;/c:when&gt;&lt;c:otherwise&gt;
&lt;div&gt;
  Value is zero.
&lt;/div&gt;
&lt;/c:otherwise&gt;&lt;/c:choose&gt;

### for Velocity
#if($value &gt; 0)
&lt;div&gt;
  Value is positive.
&lt;/div&gt;
#elseif($value &lt; 0)
&lt;div&gt;
  Value is negative.
&lt;/div&gt;
#else
&lt;div&gt;
  Value is zero.
&lt;/div&gt;
#end
</pre>
<p>「<code>elseif</code>」や「<code>else</code>」を使う場合は、直前に空行を入れないようにしてください。
</p>
<br>


<a name="kd-foreach"></a>
<h3 class="section2">繰り返し(foreach)</h3>
<p>「<code>id="foreach:<em>loopvar</em>=<em>list</em>"</code>」（または「<code>id="foreach:<em>loopvar</em>:<em>list</em>"</code>」）とすることで、リスト<code><em>list</em></code>の要素をひとつずつ変数<code><em>loopvar</em></code>に代入しながら、繰り返しを行います。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-foreach.pdata"></a>
<pre class="program">&lt;tr <strong>id="foreach:item=list"</strong>&gt;
  &lt;td&gt;@{item}@&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;% for item in list do %&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;%= item %&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;% end %&gt;

### for PHP
&lt;?php foreach ($list as $item) { ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?php echo $item; ?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;?php } ?&gt;

### for JSTL
&lt;c:forEach var="item" items="${list}"&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;c:out value="${item}" escapeXml="false"/&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/c:forEach&gt;

### for Velocity
#foreach($item in $list)
&lt;tr&gt;
  &lt;td&gt;$!{item}&lt;/td&gt;
&lt;/tr&gt;
#end
</pre>
<br>


<a name="kd-loop"></a>
<h3 class="section2">繰り返し(loop)</h3>
<p>「<code>id="loop:<em>loopvar</em>=<em>list</em>"</code>」（または「<code>id="loop:<em>loopvar</em>:<em>list</em>"</code>」）とすることで、リスト<code><em>list</em></code>の要素をひとつずつ変数<code><em>loopvar</em></code>に代入しながら繰り返しを行います。
「<code>id="foreach:<em>loopvar</em>=<em>list</em>)"</code>」とよく似ていますが、開始タグと終了タグを含めず、内容だけ繰り返す点が異なります。
&lt;dl&gt;&lt;/dl&gt;で使うと非常に便利です。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-loop.pdata"></a>
<pre class="program">&lt;dl <strong>id="loop:item=list"</strong>&gt;
  &lt;dt&gt;@{item.text}@&lt;/dt&gt;
  &lt;dd&gt;@{item.desc}@&lt;/dd&gt;
&lt;/dl&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;dl&gt;
&lt;% for item in list do %&gt;
  &lt;dt&gt;&lt;%= item.text %&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;%= item.desc %&gt;&lt;/dd&gt;
&lt;% end %&gt;
&lt;/dl&gt;

### for PHP
&lt;dl&gt;
&lt;?php foreach ($list as $item) { ?&gt;
  &lt;dt&gt;&lt;?php echo $item-&gt;text; ?&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;?php echo $item-&gt;desc; ?&gt;&lt;/dd&gt;
&lt;?php } ?&gt;
&lt;/dl&gt;

### for JSTL
&lt;dl&gt;
&lt;c:forEach var="item" items="${list}"&gt;
  &lt;dt&gt;&lt;c:out value="${item.text}" escapeXml="false"/&gt;&lt;/dt&gt;
  &lt;dd&gt;&lt;c:out value="${item.desc}" escapeXml="false"/&gt;&lt;/dd&gt;
&lt;/c:forEach&gt;
&lt;/dl&gt;

### for Velocity
&lt;dl&gt;
#foreach($item in $list)
  &lt;dt&gt;$!{item.text}&lt;/dt&gt;
  &lt;dd&gt;$!{item.desc}&lt;/dd&gt;
#end
&lt;/dl&gt;
</pre>
<br>


<a name="kd-foreach2"></a>
<h3 class="section2">カウンタつき繰り返し(Foreach,Loop)</h3>
<p>「<code>id="Foreach:<em>var</em>=<em>list</em>)"</code>」や「<code>id="Loop:<em>var</em>=<em>list</em>)"</code>」を使うと、カウンタを増やしながら繰り返しを行います。
カウンタは1から始まり、変数名は<code><em>var</em>_ctr</code>です。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-foreach2.pdata"></a>
<pre class="program">&lt;tr <strong>id="Foreach:item=list"</strong>&gt;
  &lt;td&gt;@{item_ctr}@&lt;/td&gt;
  &lt;td&gt;@{item}@&lt;td&gt;
&lt;/tr&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;% item_ctr = 0 %&gt;
&lt;% for item in list do %&gt;
&lt;%   item_ctr += 1 %&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;%= item_ctr %&gt;&lt;/td&gt;
  &lt;td&gt;&lt;%= item %&gt;&lt;td&gt;
&lt;/tr&gt;
&lt;% end %&gt;

### for PHP
&lt;?php $item_ctr = 0; ?&gt;
&lt;?php foreach ($list as $item) { ?&gt;
&lt;?php   $item_ctr += 1; ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?php echo $item_ctr; ?&gt;&lt;/td&gt;
  &lt;td&gt;&lt;?php echo $item; ?&gt;&lt;td&gt;
&lt;/tr&gt;
&lt;?php } ?&gt;

### for JSTL
&lt;c:set var="item_ctr" value="0"/&gt;
&lt;c:forEach var="item" items="${list}"&gt;
  &lt;c:set var="item_ctr" value="${item_ctr + 1}"/&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;c:out value="${item_ctr}" escapeXml="false"/&gt;&lt;/td&gt;
  &lt;td&gt;&lt;c:out value="${item}" escapeXml="false"/&gt;&lt;td&gt;
&lt;/tr&gt;
&lt;/c:forEach&gt;

### for Velocity
#set($item_ctr = 0)
#foreach($item in $list)
  #set($item_ctr = $item_ctr + 1)
&lt;tr&gt;
  &lt;td&gt;$!{item_ctr}&lt;/td&gt;
  &lt;td&gt;$!{item}&lt;td&gt;
&lt;/tr&gt;
#end
</pre>
<br>


<a name="kd-foreach3"></a>
<h3 class="section2">トグルつき繰り返し(FOREACH,LOOP)</h3>
<p>「<code>id="FOREACH:<em>var</em>=<em>list</em>"</code>」や「<code>id="LOOP:<em>var</em>=<em>list</em>"</code>」とすると、トグルつきの繰り返しを行うことができます。
トグルは、繰り返し回数が奇数回か偶数回かによって、値が入れ替わります。
トグル変数の名前は<code><em>var</em>_tgl</code>です。
トグルの値はデフォルトで「<code>"odd"</code>」と「<code>"even"</code>」が使われますが、コマンドオプション --odd と --even で指定できます。
また設定ファイルkwartz/config.rbの定数ODDとEVENでも指定できます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-foreach3.pdata"></a>
<pre class="program">&lt;table&gt;
  &lt;tbody <strong>id="LOOP:item=list"</strong>&gt;
    &lt;tr class="<strong>@{item_tgl}@</strong>"&gt;
      &lt;td&gt;@{item}@&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;table&gt;
  &lt;tbody&gt;
&lt;% item_ctr = 0 %&gt;
&lt;% for item in list do %&gt;
&lt;%   item_ctr += 1 %&gt;
&lt;%   item_tgl = item_ctr % 2 == 0 ? "even" : "odd" %&gt;
    &lt;tr class="&lt;%= item_tgl %&gt;"&gt;
      &lt;td&gt;&lt;%= item %&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;% end %&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

### for PHP
&lt;table&gt;
  &lt;tbody&gt;
&lt;?php $item_ctr = 0; ?&gt;
&lt;?php foreach ($list as $item) { ?&gt;
&lt;?php   $item_ctr += 1; ?&gt;
&lt;?php   $item_tgl = $item_ctr % 2 == 0 ? "even" : "odd"; ?&gt;
    &lt;tr class="&lt;?php echo $item_tgl; ?&gt;"&gt;
      &lt;td&gt;&lt;?php echo $item; ?&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;?php } ?&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

### for JSTL
&lt;table&gt;
  &lt;tbody&gt;
&lt;c:set var="item_ctr" value="0"/&gt;
&lt;c:forEach var="item" items="${list}"&gt;
  &lt;c:set var="item_ctr" value="${item_ctr + 1}"/&gt;
  &lt;c:set var="item_tgl" value="${item_ctr % 2 eq 0 ? 'even' : 'odd'}"/&gt;
    &lt;tr class="&lt;c:out value="${item_tgl}" escapeXml="false"/&gt;"&gt;
      &lt;td&gt;&lt;c:out value="${item}" escapeXml="false"/&gt;&lt;/td&gt;
    &lt;/tr&gt;
&lt;/c:forEach&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

### for Velocity
&lt;table&gt;
  &lt;tbody&gt;
#set($item_ctr = 0)
#foreach($item in $list)
  #set($item_ctr = $item_ctr + 1)
  #if($item_ctr % 2 == 0)
    #set($item_tgl = "even")
  #else
    #set($item_tgl = "odd")
  #end
    &lt;tr class="$!{item_tgl}"&gt;
      &lt;td&gt;$!{item}&lt;/td&gt;
    &lt;/tr&gt;
#end
  &lt;/tbody&gt;
&lt;/table&gt;
</pre>
<br>


<a name="kd-while"></a>
<h3 class="section2">繰り返し(while)</h3>
<p>「<code>id="while:<em>expression</em>"</code>」とすることで、繰り返しを行うことができます。
</p>
<p>またJSPとVelocityでは、whileを変換しようとするとエラーになります。
これは、whileに対応するカスタムタグやディレクティブがないからです。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-while.pdata"></a>
<pre class="program">&lt;tr <strong>id="while:row=sth.fetch()"</strong>&gt;
  &lt;td&gt;@{row[0]}@&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>出力用プログラム：
</p>
<pre class="output">### for eRuby
&lt;% while row = sth.fetch() do %&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;%= row[0] %&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;% end %&gt;

### for PHP
&lt;?php while ($row = $sth-&gt;fetch()) { ?&gt;
&lt;tr&gt;
  &lt;td&gt;&lt;?php echo $row[0]; ?&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;?php } ?&gt;
</pre>
<br>


<a name="kd-dummy"></a>
<h3 class="section2">ダミーデータ</h3>
<p>「<code>id="dummy:<em>str</em>"</code>」とすることで、そのノードをダミーデータとみなして読み飛ばします。
</p>
<p><code><em>str</em></code>は、id属性の値が重ならないようにするためのものであり、意味はありません。
</p>
<p>プレゼンテーションデータ：
</p>
<pre class="program">&lt;tr <strong>id="dummy:d1"</strong>&gt;
  &lt;td&gt;bar&lt;/td&gt;
&lt;/tr&gt;
&lt;tr <strong>id="dummy:d2"</strong>&gt;
  &lt;td&gt;baz&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>中間コード：
</p>
<pre class="output">                          // 何も出力されない
</pre>
<p>出力用プログラム：
</p>
<pre class="output">                          // 何も出力されない
</pre>
<br>


<a name="kd-replace"></a>
<h3 class="section2">エレメントの置換</h3>
<p>「<code>id="replace:<em>name</em>"</code>」とすることで、そのエレメントを別のエレメントに置き換えることができます。
</p>
<p>プレゼンテーションデータ：
</p>
<a name="directive-replace.pdata"></a>
<pre class="program">&lt;html&gt;
  &lt;body&gt;
    &lt;!-- ナビゲーション --&gt;
    &lt;div <strong>id="mark:breadcrumbs"</strong>&gt;
      &lt;a href="/"&gt;Home&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz"&gt;Kwartz&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz/ruby"&gt;Kwartz-ruby&lt;/a&gt;
    &lt;/div&gt;

   ....

    &lt;div <strong>id="replace:breadcrumbs"</strong>&gt;
      Home &amp;gt; Kwartz &amp;gt; Kwartz-ruby
    &lt;/span&gt;
  &lt;/div&gt;
&lt;/html
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">&lt;html&gt;
  &lt;body&gt;
    &lt;!-- ナビゲーション --&gt;
    &lt;div&gt;
      &lt;a href="/"&gt;Home&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz"&gt;Kwartz&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz/ruby"&gt;Kwartz-ruby&lt;/a&gt;
    &lt;/div&gt;

   ....

    &lt;div&gt;
      &lt;a href="/"&gt;Home&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz"&gt;Kwartz&lt;/a&gt;
      &amp;gt; &lt;a href="/kwartz/ruby"&gt;Kwartz-ruby&lt;/a&gt;
    &lt;/div&gt;
&lt;/html
</pre>
<p>なおコマンドラインオプション「<code>-i <em>file1</em>,<em>file2</em>,<em>...</em></code>」を指定すると、
他のファイルのエレメントを利用できます。
</p>
<br>


<a name="kd-placeholder"></a>
<h3 class="section2">プレースホルダ</h3>
<p>「<code>id="placeholder:<em>name</em>"</code>」とすることで、そのエレメントの内容を別のエレメントで置き換えます。
通常は、コマンドラインオプション「<code>-i <em>file1</em>,<em>file2</em>,<em>...</em></code>」とともに使用し、
他のファイルで定義されたエレメントを取り込むために使われます。
</p>
<p>プレゼンテーションデータ(article.html)：
</p>
<a name="directive-placeholder-article.pdata"></a>
<pre class="program">&lt;html&gt;
  &lt;body&gt;

    &lt;div <strong>id="mark:article"</strong>&gt;
      &lt;p&gt;Kwartz is a template system, which realized the
         concept &lt;strong&gt;`Separation of Presentation Logic
         and Presentation Data'(SoPL/PD)&lt;/strong&gt;.
      &lt;/p&gt;
    &lt;/div&gt;
    
  &lt;/body&gt;
&lt;/html&gt;

</pre>
<p>プレゼンテーションデータ(layout.html)：
</p>
<a name="directive-placeholder-layout.pdata"></a>
<pre class="program">&lt;!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
    &lt;link rel="stylesheet" type="text/css" href="design.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;

    &lt;table border="0"&gt;
      &lt;tr&gt;
        &lt;td width="400" <strong>id="placeholder:article"</strong>&gt;
          aaa&lt;br&gt;
          bbb&lt;br&gt;
          ccc&lt;br&gt;
          ddd&lt;br&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;/table&gt;
    
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>コンパイル：
</p>
<pre class="terminal">$ kwartz <strong>-i article.html</strong> layout.html
</pre>
<p>出力用スクリプト：
</p>
<pre class="output">&lt;!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
    &lt;link rel="stylesheet" type="text/css" href="design.css"&gt;
  &lt;/head&gt;
  &lt;body&gt;

    &lt;table border="0"&gt;
      &lt;tr&gt;
        &lt;td width="400"&gt;
    &lt;div&gt;
      &lt;p&gt;Kwartz is a template system, which realized the
         concept &lt;strong&gt;`Separation of Presentation Logic
         and Presentation Data'(SoPL/PD)&lt;/strong&gt;.
      &lt;/p&gt;
    &lt;/div&gt;
        &lt;/td&gt;
      &lt;/tr&gt;
    &lt;/table&gt;
    
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<br>


<a name="kd-include"></a>
<h3 class="section2">プレゼンテーションデータファイルの読み込み</h3>
<p>「<code>id="include:<em>filename</em>"</code>」で他のプレゼンテーションデータファイル（HTMLファイル）を読み込むことができます。
読み込まれる側のファイルでも、ディレクティブを使用できます。
</p>
<p>プレゼンテーションデータ(copyright.html)：
</p>
<a name="copyright.html"></a>
<pre class="program">&lt;!-- begin footer --&gt;
&lt;center&gt;
  copyright&amp;copy; &lt;span id="value:year"&gt;2005&lt;/span&gt; kuwata-lab all rights reserverd
&lt;/center&gt;
&lt;!-- end footer --&gt;
</pre>
<p>プレゼンテーションデータ(mainpage.html)：
</p>
<a name="mainpage.html"></a>
<pre class="program">&lt;html&gt;
  &lt;body&gt;

    ... main contents ...

    &lt;div id="include:copyright.html"&gt;
      ... copyright ...
    &lt;/div&gt;

  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>コンパイル：
</p>
<pre class="terminal">$ kwartz -l eruby mainpage.html &gt; mainpage.view
</pre>
<p>出力用スクリプト：
</p>
<pre class="program">### for eRuby
&lt;html&gt;
  &lt;body&gt;

    ... main contents ...

&lt;!-- begin footer --&gt;
&lt;center&gt;
  copyright&amp;copy; &lt;%= year %&gt; kuwata-lab all rights reserverd
&lt;/center&gt;
&lt;!-- end footer --&gt;

  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>「<code>include</code>」ディレクティブのほかに、「<code>Include</code>」と「<code>INCLUDE</code>」が使用できます。
</p>
<ul type="disc">
<li>「<code>include</code>」ディレクティブは、読み込んだファイルでそのエレメントを置き換えます。
</li>
<li>「<code>Include</code>」ディレクティブは、読み込んだファイルをそのエレメントの前に追加します。
</li>
<li>「<code>INCLUDE</code>」ディレクティブは、読み込んだファイルをそのエレメントの後ろに追加します。
</li>
</ul>
<p><code>include</code>ディレクティブで読み込むファイルは、別ディレクトリに置くことができます。
ファイルが置いてあるディレクトリは、コマンドラインオプション <code>--incdirs=<em>dir1</em>,<em>dir2</em>,...</code>
または設定ファイルの <code>INCDIRS</code> で指定できます。
</p>
<br>


<a name="kd-idkd"></a>
<h3 class="section2">id属性とkw:d属性について</h3>
<p>Kwartzでは、ディレクティブを記述するのにid属性とkw:d属性が使用できます。
ここでは、両者の使い分けについて説明します。
</p>
<ul type="disc">
<li>id属性もkw:d属性も、機能としては同じです。
</li>
</ul>
<p>今までid属性で説明していましたが、すべてkw:d属性に書いても動作します。
</p>
<ul type="disc">
<li>ひとつのタグにid属性とkw:d属性の両方を記述した場合、kw:d属性のほうが優先されます。
   例えば「<code>id="name" kw:d="foreach:item=list"</code>」とした場合、kw:d属性のほうが有効となります。
</li>
</ul>
<ul type="disc">
<li>ただし、kw:d属性に記述したディレクティブが<code>attr</code>のみの場合は、
   id属性のディレクティブも有効となります。
   例えば「<code>id="name" kw:d="attr:href=url"</code>」とした場合、そのエレメントは名前<code>name</code>を使ってマーキングされます。
</li>
</ul>
<ul type="disc">
<li>HTMLの仕様では、id属性の値に含めることのできる記号はアンダーバー（<code>_</code>）、コロン（<code>:</code>）、ピリオド（<code>.</code>）、ハイフン（<code>-</code>）のみです。
   そのため、<code>id="foreach:item=list"</code> や <code>id="attr:name=value"</code> という記述はHTMLの仕様からみると正しくありませんので、<code>id="foreach:item:list"</code> や <code>id="attr:name:value"</code> と書くほうがよいでしょう。
</li>
</ul>
<ul type="disc">
<li>kw:d属性の名前は、コマンドラインオプション <code>--dattr=<em>xxx</em></code> で変更することができます。
   例えばkw:d属性のかわりにstyle属性を使う場合は、 --dattr=style としてください。
   また設定ファイルの <code>DATTR</code> でも変更できます。
</li>
</ul>
<br>


<a name="kd-notes"></a>
<h3 class="section2">注意事項</h3>
<p>ディレクティブを使用する際の注意事項です。
</p>
<ul type="disc">
<li>ひとつのid属性またはkw:d属性にはひとつのディレクティブしか記述できません。
   例えば「<code>id="set:var=100;value:var"</code>」のような記述はエラーになります。
<pre class="program">## NG
&lt;span id="set:var=100;value:var"&gt;foo&lt;/span&gt;
</pre>
</li>
</ul>
<ul type="disc">
<li>ただし、attrディレクティブとappendディレクティブだけは他のディレクティブといっしょに記述できます。
   また複数のattrディレクティブとappendディレクティブを設定することもできます。
<pre class="program">## OK
&lt;foo id="foreach:item=list;attr:class=item.class;attr:href=item.url"&gt;
....
&lt;/foo&gt;
</pre>
</li>
</ul>
<ul type="disc">
<li>タグにディレクティブを含めた場合、終了タグは省略できません。
   また<code>&lt;foo .../&gt;</code>のような空要素タグは使用できます。
<pre class="program">## NG
&lt;ul&gt;
  &lt;li id="value:item"&gt;foo
&lt;/ul&gt;
## OK
&lt;a id="attr:name=refname"/&gt;
</pre>
</li>
</ul>
<ul type="disc">
<li>ディレクティブしか含まないような&lt;span&gt;&lt;/span&gt;は、削除されます。
   例えば「<code>Hello &lt;span id="value:name"&gt;World&lt;/span&gt;!</code>」というプレゼンテーションデータは、&lt;span&gt;&lt;/span&gt;が削除されて「<code>Hello &lt;%= name %&gt;!</code>」（eRubyの場合）という出力ファイルになります。
<pre class="program">## プレゼンテーションデータ
Hello &lt;span id="value:name"&gt;World&lt;/span&gt;!
## 出力用スクリプト for eRuby
Hello &lt;%= name %&gt;!
</pre>
</li>
</ul>
<ul type="disc">
<li>ディレクティブを含むタグでは、ほかの属性は必ず「<code><em>attr</em>="<em>value</em>"</code>」の形で記述し、属性名や属性値を省略しないようにしてください。
   これはHTML/XML以外でもKwartzを使用できるようにするための意図した仕様であり、バグではありません。
<pre class="program">## NG
&lt;input type="checkbox" id="foreach:item=list" <strong>checked</strong>/&gt;
## OK
&lt;input type="checkbox" id="foreach:item=list" <strong>checked="checked"</strong>/&gt;

## NG
&lt;option id="attr:value=val" @{flag ? 'selected' : ''}@/&gt;
## OK
&lt;option value="@{val}@" @{flag ? 'selected' : ''}@&gt;
</pre>
</li>
</ul>
<br>


<br>


<a name="plogic"></a>
<h2 class="section1">プレゼンテーションロジックファイル</h2>
<p>プレゼンテーションロジックファイルの書き方です。
</p>
<p>プレゼンテーションロジック：
</p>
<pre class="program">「id="mark:<em>name</em>"」でマーキングされたエレメントの宣言
#<em>name</em> {
  
  // 内容のかわりに出力する式
  value:  <em>expression</em>;
  
  // 属性（名前と値）
  attrs: "<em>attr1</em>" <em>expr1</em>, "<em>attr2</em>" <em>expr2</em>, "<em>attr3</em>" <em>expr3</em>;
  
  // 削除する属性の名前
  remove:  "<em>attr1</em>", "<em>attr2</em>", "<em>attr3</em>";
  
  // 開始タグに追加する式
  append:  <em>expr1</em>, <em>expr2</em>, <em>expr3</em>;
  
  // タグ名
  tagname: "<em>tagname</em>",

  // プレゼンテーションロジック本体
  plogic: {
    @stag;
    @cont;
    @etag;
  }
}

// ドキュメント宣言
#DOCUMENT {
  // はじめに実行されるロジック
  begin: {
    ...
  }

  // 最後に実行されるロジック
  end: {
    ...
  }
  
  // 他のプレゼンテーションロジックファイルを読み込む
  require: "file1.plogic", "file2.plogic";
}
</pre>
<br>


<a name="opt"></a>
<h2 class="section1">コマンドラインオプション</h2>
<p>テンプレートを出力用プログラムへコンパイルするには、kwartzコマンドを使用します。
</p>
<p>使い方：
<strong><code>kwartz [options...] [-p plogic ] pdata.html &gt; output-script</code></strong>
</p>
<p>オプションは次の通りです。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
-h, --help</strong></dt>
<dd class="dd3">
	ヘルプを表示。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-v</strong></dt>
<dd class="dd3">
	バージョン情報を表示
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-a <em>action</em></strong></dt>
<dd class="dd3">
	実行する処理。<em>action</em>には次のどれかを指定する（デフォルトはcompile）。
	<dl class="dl1" compact>
	<dt class="dt1">
compile</dt>
	<dd class="dd1">
		プレゼンテーションデータとプレゼンテーションロジックを読み込み、出力用スクリプトを生成します。
	</dd>
	<dt class="dt1">
analyze</dt>
	<dd class="dd1">
		プレゼンテーションデータとプレゼンテーションロジックを読み込み、変数のスコープを解析します。
	</dd>
	<dt class="dt1">
defun</dt>
	<dd class="dd1">
		プレゼンテーションデータとプレゼンテーションロジックを読み込み、RubyまたはPHPの関数に変換します。
	</dd>
	<dt class="dt1">
convert</dt>
	<dd class="dd1">
		プレゼンテーションデータを読み込み、PLプログラムに変換します。デバッグ用です。
	</dd>
	<dt class="dt1">
transalte</dt>
	<dd class="dd1">
		PLプログラムを読み込み、出力用スクリプトに変換します。デバッグ用です。
	</dd>
	</dl>
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-e , -s</strong></dt>
<dd class="dd3">
	サニタイズを行う。<code>--escape=true</code>と同じ。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-i <em>file1,file2,...</em></strong></dt>
<dd class="dd3">
	外部ファイルで定義されたエレメントをインポートする。
	主にplaceholderディレクティブ（「<code>id="placeholder:<em>name</em></code>」）のために使用される。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-l <em>lang</em></strong></dt>
<dd class="dd3">
	ターゲット言語を指定。指定できるのは
	eruby, erb, php, jstl11, jstl10, velocity.
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-p <em>plogic-file</em></strong></dt>
<dd class="dd3">
	プレゼンテーションロジックのファイル名。「<code>,</code>」で区切ることで、複数のファイル名を指定できる。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
-R <em>arg</em></strong></dt>
<dd class="dd3">
	特殊オプション。今のところ以下の引数のみ指定可能。
	<ul type="disc">
	<li>ails ... 「<code>-l erb --globalvar-prefix='@'</code>」と同じ。Ruby on Rails用のファイルを出力する。
	</li>
	</ul>
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--charset=<em>charset</em></strong></dt>
<dd class="dd3">
	文字コード。JSTLにおいて '<code>&lt;%@ page contentType="text/html; charset=<em>charset</em> "%&gt;</code>' を出力する。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--dname=<em>name</em></strong></dt>
<dd class="dd3">
	ディレクティブで使用する属性名。デフォルトは 'kw:d'。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--escape=<em>true</em>|<em>false</em></strong></dt>
<dd class="dd3">
	式をサニタイズして出力する。値が省略されたときはtrueが指定されたものとみなす。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--even=<em>value</em></strong></dt>
<dd class="dd3">
	偶数のときの値。デフォルトは「<code>'even'</code>」。ディレクティブFOREACHとLISTで使われる。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--extract=<em>name</em></strong></dt>
<dd class="dd3">
	指定された名前でマーキングされたエレメントだけを抽出する。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--footer=<em>string</em></strong></dt>
<dd class="dd3">
	フッター文字列。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--header=<em>string</em></strong></dt>
<dd class="dd3">
	ヘッダー文字列。
	JSPではデフォルトで '<code>&lt;%@ taglib prefix="c" uri="http://java.sun.com/jstl/core" %&gt;</code>'
	が設定される。
	これを出力したくないときは <code>--header=false</code> とする。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--indent=' '</strong></dt>
<dd class="dd3">
	出力用スクリプトのインデントを指定する。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--incdirs=<em>dir1</em>,<em>dir2</em>,...</strong></dt>
<dd class="dd3">
	<code>include</code>ディレクティブで読み込むファイル（プレゼンテーションデータファイル）のディレクトリを指定する。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--odd=<em>value</em></strong></dt>
<dd class="dd3">
	奇数のときの値。デフォルトは「<code>'odd'</code>」。ディレクティブFOREACHとLISTで使われる。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--localvar-prefix=<em>string</em></strong></dt>
<dd class="dd3">
	テンプレートローカル変数につけるプレフィックスを指定する。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
--globalvar-prefix=<em>string</em></strong></dt>
<dd class="dd3">
	テンプレートグローバル変数につけるプレフィックスを指定する。
</dd>
</dl>
<p>使い方の例です。
</p>
<ul type="disc">
<li>プレゼンテーションデータ(file1.html)をコンパイルして、出力用スクリプト(file1.php)に変換する。
	ターゲット言語はeRuby。
<pre class="terminal">$ kwartz -l eruby file1.html &gt; file1.rhtml
</pre>
</li>
</ul>
<ul type="disc">
<li>プレゼンテーションデータ(file1.html)とプレゼンテーションロジック(file1.plogic)から、出力用スクリプト(file1.php)を作成する。
	ターゲット言語はPHP。
<pre class="terminal">$ kwartz -l php -p file1.plogic file1.html &gt; file1.php
</pre>
</li>
</ul>
<ul type="disc">
<li>プレゼンテーションデータをPLプログラムにコンバートする。
<pre class="terminal">$ kwartz -a convert file1.html | more
</pre>
</li>
</ul>
<br>


<a name="config"></a>
<h2 class="section1">設定オプション</h2>
<p>設定ファイルで、Kwartzのオプションを指定できます。
Kwartzの設定ファイルは、実装ごとに異なります。
Kwartz-rubyでは、kwartz/config.rbです。
</p>
<p>設定ファイルでは、以下のオプションが設定できます。
</p>
<dl class="dl3">
<dt class="dt3"><strong>
ESCAPE </strong></dt>
<dd class="dd3">
	自動サニタイズをデフォルトでオンにするか、オフにするかを指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
NEWLINE </strong></dt>
<dd class="dd3">
	改行を表す文字列を指定します。
	ただし、Kwartzは改行が「\n」か「\r\n」かを自動判別することができるので、通常は変更する必要はありません。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
INDENT </strong></dt>
<dd class="dd3">
	インデントとして使う空白文字列を指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
LOCALVAR_PREFIX </strong></dt>
<dd class="dd3">
	テンプレートローカル変数のプレフィックス（頭につける文字列）を指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
GLOBALVAR_PREFIX </strong></dt>
<dd class="dd3">
	テンプレートグローバル変数のプレフィックス（頭につける文字列）を指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
LANG </strong></dt>
<dd class="dd3">
	デフォルトの出力用言語を指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
ODD </strong></dt>
<dd class="dd3">
	トグル変数の奇数値を指定します。
	「<code>id="FOREACH:<em>var</em>=<em>list</em>"</code>」と「<code>id="LOOP:<em>var</em>=<em>list</em>"</code>」で使用されます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
EVEN </strong></dt>
<dd class="dd3">
	トグル変数の偶数値を指定します。
	「<code>id="FOREACH:<em>var</em>=<em>list</em>"</code>」と「<code>id="LOOP:<em>var</em>=<em>list</em>"</code>」で使用されます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
DATTR </strong></dt>
<dd class="dd3">
	ディレクティブで使用する属性名を指定します。デフォルトは<code>kw:d</code>です。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
NOEND </strong></dt>
<dd class="dd3">
	終了タグを必要としないタグ名のリストです。デフォルトは [ "input", "br", "meta", "img", "hr" ] です。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
DEFUN_CLASS </strong></dt>
<dd class="dd3">
	コマンドラインオプション'-a defun'を使って関数を定義するときの、
	デフォルトのクラス名またはモジュール名です。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
DEFUN_FUNCTION </strong></dt>
<dd class="dd3">
	コマンドラインオプション'-a defun'を使って関数を定義するときの、
	デフォルトの関数名またはメソッド名です。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
CHARSET </strong></dt>
<dd class="dd3">
	文字コードを指定します。出力用言語がjstl11、jstl10のときに使用されます。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
EMBED_PATTERN </strong></dt>
<dd class="dd3">
	プレゼンテーションデータ中に式を埋め込むためのパターンを指定します。
</dd>
</dl>
<dl class="dl3">
<dt class="dt3"><strong>
INCDIRS </strong></dt>
<dd class="dd3">
	「<code>include:</code>」ディレクティブで読み込むファイルを探すディレクトリを指定します。
	デフォルトは [ "." ] つまりカレントディレクトリです。
</dd>
</dl>
<br>



   </div>
  </blockquote>

 </body>
</html>
